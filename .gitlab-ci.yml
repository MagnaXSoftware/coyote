image: golang:1.7

before_script:
  - mkdir -p "$GOPATH/src/git.magnax.ca/$CI_PROJECT_NAMESPACE"
  - ln -s "$CI_PROJECT_DIR" "$GOPATH/src/git.magnax.ca/$CI_PROJECT_PATH"
  - cd "$GOPATH/src/git.magnax.ca/$CI_PROJECT_PATH"

stages:
  - prep
  - build

vet:
  script:
    - make vet
  stage: prep
  tags:
    - go

build:
  script:
    - export VERSION=$CI_BUILD_REF_NAME-$CI_BUILD_REF
    - make build
  stage: build
  tags:
    - go
  except:
    - tags

.release: &release
  stage: build
  tags:
    - go
  artifacts:
    paths:
      - build/*
  only:
    - tags

release-386:
  <<: *release
  script:
    - export ARCH=386
    - export VERSION=$CI_BUILD_TAG
    - make release
  artifacts:
    name: "coyote-386-$CI_BUILD_TAG"

release-arm:
  <<: *release
  script:
    - export ARCH=arm
    - export VERSION=$CI_BUILD_TAG
    - make release
  artifacts:
    name: "coyote-arm-$CI_BUILD_TAG"

release-amd64:
  <<: *release
  script:
    - export ARCH=amd64
    - export VERSION=$CI_BUILD_TAG
    - make release
  artifacts:
    name: "coyote-amd64-$CI_BUILD_TAG"
